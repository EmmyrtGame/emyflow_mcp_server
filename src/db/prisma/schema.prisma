generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // Hash bcrypt
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Client {
  id        String   @id @default(cuid())
  slug      String   @unique  // Ej: "white_dental"
  name      String              // Nombre visible
  isActive  Boolean  @default(true)
  webhookUrl String?  // Custom webhook URL for this client
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Configuraciones anidadas (JSON)
  meta            Json  // { pixelId, accessToken }
  wassenger       Json  // { apiKey, deviceId }
  // Removed legacy location and availabilityStrategy fields
  locations       Json? // MÃºltiples sedes (opcional)
  reminderTemplates Json  // { "24h", "3h", "1h" }
  
  // Relations
  serviceAccountId String?
  serviceAccount   ServiceAccount? @relation(fields: [serviceAccountId], references: [id])
  
  // Analytics Relations
  events  ClientEvent[]
  stats   ClientStats?

  // Metadatos
  timezone              String  @default("America/Mexico_City")
  wassengerDeviceId     String? @unique
}

model ServiceAccount {
  id          String   @id @default(cuid())
  name        String   @unique // Identifier (e.g., project_id or filename)
  email       String?  // client_email derived from JSON
  fileName    String?  // Original filename for display
  encryptedContent String @db.Text // JSON content usually
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  clients     Client[]
}

// Tracks individual events for granular analysis
model ClientEvent {
  id        String   @id @default(cuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  eventType String   // 'LEAD', 'APPOINTMENT', 'MESSAGE', 'HANDOFF', 'NEW_CONVERSATION'
  phone     String?  // Associated phone number (for deduplication/analysis)
  metadata  Json?    // Optional additional data
  createdAt DateTime @default(now())
  
  @@index([clientId, eventType, createdAt])
  @@index([clientId, createdAt])
}

// Pre-aggregated counters for O(1) dashboard reads
model ClientStats {
  id                  String   @id @default(cuid())
  clientId            String   @unique
  client              Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Lifetime counters
  totalLeads          Int      @default(0)
  totalAppointments   Int      @default(0)
  totalMessages       Int      @default(0)
  totalHandoffs       Int      @default(0)
  totalNewConversations Int    @default(0)
  
  // Monthly counters (current month)
  monthlyLeads        Int      @default(0)
  monthlyAppointments Int      @default(0)
  monthlyMessages     Int      @default(0)
  monthlyHandoffs     Int      @default(0)
  monthlyNewConversations Int  @default(0)
  currentMonth        String?  // "2025-12" format for reset logic
  
  updatedAt           DateTime @updatedAt
}
